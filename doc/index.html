<!DOCTYPE html><html lang="en"><head><title>index</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="index"><meta name="groc-project-path" content="samples/samples.rb"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">samples/samples.rb</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="overview">Overview</h1>

<p>Welcome to the Pacto usage samples!
This document gives a quick overview of the main features.
You can browse the Table of Contents (upper right corner) to view additional samples.
In addition to this document, here are some highlighted samples:</p>

<ul>
  <li><a href="configuration.html">Configuration</a>: Shows all available configuration options</li>
  <li><a href="generation.html">Generation</a>: More details on generation</li>
  <li><a href="rspec.html">RSpec</a>: More samples for RSpec expectations</li>
</ul></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>You can also find other samples using the Table of Content (upper right corner), including sample contracts.</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="getting-started">Getting started</h1>

<p>Once you've installed the Pacto gem, you just require it.  If you want, you can also require the Pacto rspec expectations.</p></div></div><div class="code"><div class="wrapper"><span class="nb">require</span> <span class="s1">&#39;pacto&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;pacto/rspec&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pacto will disable live connections, so you will get an error if
your code unexpectedly calls an service that was not stubbed.  If you
want to re-enable connections, run <code>WebMock.allow_net_connect!</code></p></div></div><div class="code"><div class="wrapper"><span class="no">WebMock</span><span class="o">.</span><span class="n">allow_net_connect!</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pacto can be configured via a block.  The <code>contracts_path</code> option tells Pacto where it should load or save contracts.  See the <a href="configuration.html">Configuration</a> for all the available options.</p></div></div><div class="code"><div class="wrapper"><span class="no">Pacto</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="o">.</span><span class="n">contracts_path</span> <span class="o">=</span> <span class="s1">&#39;contracts&#39;</span>
<span class="k">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="generating-a-contract">Generating a Contract</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Calling <code>Pacto.generate!</code> enables <a href="https://www.relishapp.com/maxlinc/pacto/v/0-3-0/docs/generate">contract generation</a>.</p></div></div><div class="code"><div class="wrapper"><span class="no">Pacto</span><span class="o">.</span><span class="n">generate!</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Now, if we run any code that makes an HTTP call (using an
<a href="https://github.com/bblimke/webmock#supported-http-libraries">HTTP library supported by WebMock</a>)
then Pacto will generate a Contract based on the HTTP request/response.
Here, we're using <a href="https://github.com/octokit/octokit.rb">Octokit</a> to call the GitHub API.  It will generate a Contract and save it two <code>contracts/api.github.com/repos/thoughtworks/pacto/readme.json</code>.</p></div></div><div class="code"><div class="wrapper"><span class="nb">require</span> <span class="s1">&#39;octokit&#39;</span>
<span class="n">readme</span> <span class="o">=</span> <span class="no">Octokit</span><span class="o">.</span><span class="n">readme</span> <span class="s1">&#39;thoughtworks/pacto&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We're getting back real data from GitHub, so this should be the actual file encoding.</p></div></div><div class="code"><div class="wrapper"><span class="nb">puts</span> <span class="n">readme</span><span class="o">.</span><span class="n">encoding</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="testing-providers-by-simulating-consumers">Testing providers by simulating consumers</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The generated contract will contain expectations based on the request/response we observed,
including a best-guess at an appropriate json-schema.  Our heuristics certainly aren't foolproof,
so you might want to modify the output!</p></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We can load the contract and validate it, by sending a new request and making sure
the response matches the JSON schema.  Obviously it will pass since we just recorded it,
but if the service has made a change, or if you alter the contract with new expectations,
then you will see a contract validation message.</p></div></div><div class="code"><div class="wrapper"><span class="n">contracts</span> <span class="o">=</span> <span class="no">Pacto</span><span class="o">.</span><span class="n">load_contracts</span><span class="p">(</span><span class="s1">&#39;contracts&#39;</span><span class="p">,</span> <span class="s1">&#39;https://api.github.com&#39;</span><span class="p">)</span>
<span class="n">contracts</span><span class="o">.</span><span class="n">validate_all</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="stubbing-providers-for-consumer-testing">Stubbing providers for consumer testing</h1>

<p>We can also use Pacto to stub the service based on the contract.</p></div></div><div class="code"><div class="wrapper"><span class="n">contracts</span><span class="o">.</span><span class="n">stub_all</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The stubbed data won't be very realistic, the default behavior is to return the simplest data
that complies with the schema.  That basically means that you'll have "bar" for every string.</p></div></div><div class="code"><div class="wrapper"><span class="n">readme</span> <span class="o">=</span> <span class="no">Octokit</span><span class="o">.</span><span class="n">readme</span> <span class="s1">&#39;thoughtworks/pacto&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>You're now getting stubbed data.  Unless you generated the schema with the <code>defaults</code> option enabled,
then this will just return "bar" as the encoding.  If you recorded the defaults, then it will return
the value received when the Contract was generated.</p></div></div><div class="code"><div class="wrapper"><span class="nb">puts</span> <span class="n">readme</span><span class="o">.</span><span class="n">type</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="collaboration-tests-with-rspec">Collaboration tests with RSpec</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>You can turn on validation mode so Pacto will detect and validate HTTP requests.</p></div></div><div class="code"><div class="wrapper"><span class="no">Pacto</span><span class="o">.</span><span class="n">validate!</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Pacto comes with rspec matchers</p></div></div><div class="code"><div class="wrapper"><span class="nb">require</span> <span class="s1">&#39;pacto/rspec&#39;</span>
<span class="n">describe</span> <span class="s1">&#39;my_code&#39;</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">&#39;calls a service&#39;</span> <span class="k">do</span>
    <span class="no">Octokit</span><span class="o">.</span><span class="n">readme</span> <span class="s1">&#39;thoughtworks/pacto&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The have_validated matcher makes sure that Pacto received and successfully validated a request</p></div></div><div class="code"><div class="wrapper">    <span class="n">expect</span><span class="p">(</span><span class="no">Pacto</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_validated</span><span class="p">(</span><span class="ss">:get</span><span class="p">,</span> <span class="s1">&#39;https://api.github.com/repos/thoughtworks/pacto/readme&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>It's probably a good idea to reset Pacto between each rspec scenario</p></div></div><div class="code"><div class="wrapper"><span class="no">RSpec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="n">c</span><span class="o">.</span><span class="n">after</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span>  <span class="p">{</span> <span class="no">Pacto</span><span class="o">.</span><span class="n">clear!</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">contracts</span> <span class="o">=</span> <span class="no">Pacto</span><span class="o">.</span><span class="n">load_contracts</span><span class="p">(</span><span class="s1">&#39;contracts&#39;</span><span class="p">,</span> <span class="s1">&#39;https://api.github.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">stub_all</span>
<span class="no">Pacto</span><span class="o">.</span><span class="n">validate!</span>

<span class="n">describe</span> <span class="s1">&#39;my_code&#39;</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">&#39;calls a service&#39;</span> <span class="k">do</span>
    <span class="no">Octokit</span><span class="o">.</span><span class="n">readme</span> <span class="s1">&#39;thoughtworks/pacto&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>The have_validated matcher makes sure that Pacto received and successfully validated a request</p></div></div><div class="code"><div class="wrapper">    <span class="n">expect</span><span class="p">(</span><span class="no">Pacto</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">have_validated</span><span class="p">(</span><span class="ss">:get</span><span class="p">,</span> <span class="s1">&#39;https://api.github.com/repos/thoughtworks/pacto/readme&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></div></div></div></div></body></html>